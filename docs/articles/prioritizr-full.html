<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Conservation Prioritization with Integer Programming in R &bull; prioritizr</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">prioritizr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/mstrimas/prioritizr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Conservation Prioritization with Integer Programming in R</h1>
            
          </div>

    
    
<div class="contents">
<p><strong>Systematic conservation prioritization</strong> takes a rigorous, repeatable, and systematic approach to designing new protected areas that efficiently meet conservation objectives, while minimizing socioeconomic cost. <code>prioritizr</code> is an R package for identifying the optimal location of new protected areas using the techniques of integer linear programming (ILP). In contrast to heuristic methods, such as simulated annealing (e.g.&nbsp;as implemented by <a href="http://uq.edu.au/marxan/">Marxan</a>), the ILP methods used by <code>prioritizr</code> find exact solutions to optimization problems and can produce higher quality solutions more efficiently.</p>
<p>In this tutorial, I will begin by introducing reserve design and integer linear programming in general, discuss the different types of reserve design problems and how to implement them in <code>prioritizr</code>, and finally demonstrate how to solve these problems.</p>
<div id="background" class="section level1">
<h1 class="hasAnchor"><html><body><a href="#background" class="anchor"> </a></body></html>Background</h1>
<div id="reserve-design" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#reserve-design" class="anchor"> </a></body></html>Reserve design</h2>
<p>A reserve design exercise starts by dividing the study region into <strong>planning units</strong> (typically square or hexagonal cells) and, for each planning unit, assigning values that quantify socioeconomic cost and conservation benefit for a set of conservation features. The <strong>cost</strong> can be the acquisition cost of the land, the cost of management, the opportunity cost of foregone commercial activities (e.g.&nbsp;from logging or agriculture), or simply the area. The <strong>conservation features</strong> are typically species (e.g.&nbsp;Clouded Leopard) or habitats (e.g.&nbsp;mangroves or cloud forest). The benefit that each feature derives from a planning unit can take a variety of forms, but is typically either occupancy (i.e.&nbsp;presence or absence) or area of occurrence within each planning unit. Finally, in some types of reserve design models, for each conservation feature, representation targets must be set, such as 20% of the current extent of cloud forest or 10,000km<sup>2</sup> of Clouded Leopard habitat.</p>
<p>The goal of the reserve design exercise is then to optimize the trade-off between conservation benefit and socioeconomic cost, i.e.&nbsp;to get the most benefit for your limited conservation funds. Different reserve design models achieve this in different ways. In the minimum set cover model used by Marxan, the goal is to find the set of planning units that meets the representation targets while minimizing cost. Alternatively, in the maximum coverage model, the goal is to maximum the overall representation of conservation features while keeping cost within a fixed budget. Other approaches are possible that build on these basic models.</p>
</div>
<div id="mathematical-formulation" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#mathematical-formulation" class="anchor"> </a></body></html>Mathematical formulation</h2>
<p>Formulating the conservation objective mathematically as an optimization problem allows us to tap into the rich body of knowledge that exists in the field of <a href="https://en.wikipedia.org/wiki/Mathematical_optimization">mathematical optimization</a>. In general, the goal of an optimization problem is to minimize an <strong>objective function</strong> over a set of <strong>decision variables</strong>, subject to a series of <strong>constraints</strong>. The decision variables are what we control, usually there is one binary variable for each planning unit specifying whether or not to protect that unit. The constraints can be thought of as rules that need to be followed, for example, that the reserve must stay within a certain budget or meet the representation targets.</p>
<p>In the particular case of a minimum set cover problem, the reserve design problem is formulated, for <span class="math inline">\(n\)</span> planning units and <span class="math inline">\(m\)</span> conservation features, as:</p>
<p><span class="math display">\[
\text{Minimize} \sum_{i=1}^{n}x_i c_i + 
\text{ subject to } \sum_{j=1}^{n}x_j r_{ij}
\geq T_i \space \forall \space i 
\]</span></p>
<p>where <span class="math inline">\(x_i\)</span> is a binary decision variable specifying whether planning unit <span class="math inline">\(i\)</span> has been selected (1) or not (0), <span class="math inline">\(c_i\)</span> is the cost of planning unit <span class="math inline">\(i\)</span>, <span class="math inline">\(r_{ij}\)</span> is the representation level of feature <span class="math inline">\(i\)</span> in planning unit <span class="math inline">\(j\)</span>, and <span class="math inline">\(T_i\)</span> is the target for feature <span class="math inline">\(i\)</span>. The first term is the objective function and the second is the set of constraints. In words this says &ldquo;find the set of planning units that meets all the representation targets while minimizing the overall cost&rdquo;.</p>
</div>
<div id="integer-linear-programming-ilp" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#integer-linear-programming-ilp" class="anchor"> </a></body></html>Integer linear programming (ILP)</h2>
<p><strong>Mathematical optimization</strong> is the field that deals with solving optimizing problems, including problems of the type posed above. <a href="https://en.wikipedia.org/wiki/Integer_programming"><strong>Integer programming (IP)</strong></a> problems comprise the subset of optimization problems in which the decision variables are restricted to be integers. Reserve design problems fall into this category because the decision variables are binary, corresponding to whether or not each planning unit is selected. Finally, <strong>integer linear programming (ILP)</strong> problems are IP problems in which the objective function is linear. Both the minimum set cover and maximum coverage problems are ILP problems.</p>
<p>The general form of an ILP problem can be expressed in matrix notation as:</p>
<p><span class="math display">\[
\text{Minimize} \space \boldsymbol{c}^\text{T} \boldsymbol{x} \space
\space \text{subject to} \space A\boldsymbol{x}
\space \Box \space \boldsymbol{b}
\]</span></p>
<p>where <span class="math inline">\(\boldsymbol{x}\)</span> is a vector of decision variables, <span class="math inline">\(\boldsymbol{c}\)</span> and <span class="math inline">\(\boldsymbol{b}\)</span> are vectors of known coefficients, and <span class="math inline">\(A\)</span> is the <strong>constraint matrix</strong>. The final term specifies a series of <strong>structural constaints</strong> and the <span class="math inline">\(\Box\)</span> symbol is used to indicate that the relational operators for the constraint can be either <span class="math inline">\(\ge\)</span>, <span class="math inline">\(=\)</span>, or <span class="math inline">\(\le\)</span>. For the minimum set cover problem described above, <span class="math inline">\(\boldsymbol{c}\)</span> would be a vector of costs for each planning unit, <span class="math inline">\(\boldsymbol{b}\)</span> a vector of targets for each conservation feature, <span class="math inline">\(\Box\)</span> would be <span class="math inline">\(\ge\)</span> for all features, and <span class="math inline">\(A\)</span> would be the representation matrix with <span class="math inline">\([A]_{ij}=r_{ij}\)</span> the representation level of feature <span class="math inline">\(j\)</span> in planning unit <span class="math inline">\(i\)</span>.</p>
<p>Fortunately a wide variety of approaches have been developed for solving optimization problems. Reserve design problems are frequently solved using <a href="https://en.wikipedia.org/wiki/Simulated_annealing"><strong>simulated annealing</strong></a>, a stochastic heuristic for approximating global optima of complex functions. This method is conceptually simple and can be applied to a wide variety of optimization problems, however, it won&rsquo;t, in general, find the true optimal solution. More importantly, it is impossible to quantify how close the resulting solution is to the optimal solution.</p>
<p>The <code>prioritizr</code> package focuses on using more modern algorithms that can efficiently solve ILP problems exactly or to within a given gap to optimality. These exact ILP algorithms are implemented in a variety of commercial and open source solvers and <code>prioritzr</code> provides a unified interface to some of these solvers. The intention is to abstract away the details of these solvers so that the user requires minimal knowledge of the specific solvers or ILP in general. The currently supported solvers are as follows. Each must be installed separately from this package to be accessible.</p>
<ul><li><a href="http://gurobi.com">Gurobi</a> is a state-of-the-art commercial optimization software with an R package interface. It is by far the fastest of the solvers available in this package, however, it is also the only one that isn&rsquo;t free. That said, free academic licenses are available.</li>
<li><a href="https://projects.coin-or.org/SYMPHONY">SYMPHONY</a> is an open-source integer programming solver that is part of the Computational Infrastructure for Operations Research (COIN-OR) project, an initiative to promote development of open-source tools for operations research (a field that includes linear programming). Two R packages exist to provide interfaces to SYMPHONY: <code>Rsymphony</code> (on CRAN) and <code>lpsymphony</code> (on Bioconductor). On Windows and Mac,  may be easier to install.</li>
<li>The GNU Linear Programming Kit (<a href="https://www.gnu.org/software/glpk/">GLPK</a>) is an open-source package for solving linear and integer linear programs. The R package glpkAPI provides an interface to the low-level GLPK API.</li>
</ul></div>
</div>
<div id="using-prioritizr" class="section level1">
<h1 class="hasAnchor"><html><body><a href="#using-prioritizr" class="anchor"> </a></body></html>Using <code>prioritizr</code></h1>
<p>This package consists largely of two layers of functions: those that define a reserve design problem and those that solve a reserve design problem using any one of the available solvers. In this tutorial, I begin by generating some example data, then demonstrate how to construct each of the three possible reserve design model types, and finally I solve these reserve design problems and examine the solutions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sp)
<span class="kw">library</span>(raster)
<span class="kw">library</span>(prioritizr)
<span class="co"># for plotting</span>
<span class="kw">library</span>(rasterVis)
<span class="kw">library</span>(viridis)
<span class="kw">library</span>(ggplot2)</code></pre></div>
<div id="data-generation" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#data-generation" class="anchor"> </a></body></html>Data generation</h2>
<p>The function <code><a href="../reference/gaussian_field.html">gaussian_field()</a></code> can be used to generate spatially auto-correlated random fields, to be used as semi-realistic spatial variables. All conservation prioritization problems involve balancing a trade-off between representing features of conservation interest and minimizing the cost of protection. Therefore I start by generating distributions for four species and a cost layer, all on a 100x100 raster grid of planning units. I also define a mesh of hexagonal planning units over the study area.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1</span>)
<span class="co"># raster 100x100 template</span>
e &lt;-<span class="st"> </span><span class="kw">extent</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">0</span>, <span class="dv">100</span>)
r &lt;-<span class="st"> </span><span class="kw">raster</span>(e, <span class="dt">nrows =</span> <span class="dv">100</span>, <span class="dt">ncols =</span> <span class="dv">100</span>, <span class="dt">vals =</span> <span class="dv">1</span>)
<span class="co"># hexagonal study grid</span>
hex_grid &lt;-<span class="st"> </span><span class="kw"><a href="../reference/make_grid.html">make_grid</a></span>(r, <span class="dt">type =</span> <span class="st">"hexagonal"</span>, <span class="dt">cell_area =</span> <span class="dv">100</span>, <span class="dt">clip =</span> <span class="ot">TRUE</span>)
<span class="co"># generate 9 feature distributions with different scales and range sizes</span>
species &lt;-<span class="st"> </span><span class="kw">mapply</span>(function(x, y, r) <span class="kw"><a href="../reference/gaussian_field.html">gaussian_field</a></span>(<span class="dt">r =</span> r, <span class="dt">range =</span> x, <span class="dt">prop =</span> y),
                  <span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">25</span>), <span class="dt">each =</span> <span class="dv">2</span>),
                  <span class="kw">rep</span>(<span class="kw">c</span>(<span class="fl">0.1</span>, <span class="fl">0.5</span>), <span class="dt">times =</span> <span class="dv">2</span>),
                  <span class="dt">MoreArgs =</span> <span class="kw">list</span>(<span class="dt">r =</span> r))
species &lt;-<span class="st"> </span><span class="kw">stack</span>(species)
species &lt;-<span class="st"> </span><span class="kw">setNames</span>(species, letters[<span class="dv">1</span>:<span class="kw">nlayers</span>(species)])
<span class="kw">levelplot</span>(species, <span class="dt">main =</span> <span class="st">'Species Distributions'</span>, <span class="dt">layout =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>),
          <span class="dt">scales =</span> <span class="kw">list</span>(<span class="dt">draw =</span> <span class="ot">FALSE</span>),
          <span class="dt">col.regions =</span> <span class="kw">c</span>(<span class="st">"grey20"</span>, <span class="st">"#fd9900"</span>), <span class="dt">colorkey =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="figures/full_generate-data-1.png" width="672" style="display: block; margin: auto;"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># generate cost layer</span>
cost &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gaussian_field.html">gaussian_field</a></span>(r, <span class="dv">20</span>, <span class="dt">mean =</span> <span class="dv">1000</span>, <span class="dt">variance =</span> <span class="dv">500</span>)
cost &lt;-<span class="st"> </span><span class="kw">setNames</span>(cost, <span class="st">"cost"</span>)
<span class="kw">levelplot</span>(cost, <span class="dt">main =</span> <span class="st">"Cost"</span>, <span class="dt">margin =</span> <span class="ot">FALSE</span>,
          <span class="dt">col.regions =</span> <span class="kw">viridis</span>(<span class="dv">100</span>))</code></pre></div>
<p><img src="figures/full_generate-data-2.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div id="problem-specification" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#problem-specification" class="anchor"> </a></body></html>Problem specification</h2>
<p><code>prioritizr</code> currently handles three types of prioritization models: minimum set cover, maximum coverage, and a hybrid model called maximum target coverage. Each model has a corresponding function that constructs an S3 object encapsulating the prioritization problem.</p>
<div id="minimum-set-cover-problem" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#minimum-set-cover-problem" class="anchor"> </a></body></html>Minimum set cover problem</h3>
<p>In the context of systematic reserve design, the minimum set cover problem seeks to find the set of planning units that minimizes the overall cost of a reserve network, while meeting a set of representation targets for the conservation features. This problem is equivalent to a simplified Marxan reserve design problem, with the Boundary Length Modifier (BLM) set to zero. To specify a prioritization model of this type, use the <code><a href="../reference/minsetcover_model.html">minsetcover_model()</a></code> function to create a <code>minsetcover_model</code> S3 object. This function takes data in a variety of formats (raster, vector, or tabular) and generates a standard object encapsulating the prioritization problem.</p>
<p>In the simplest form, the planning units are the cells of a <code>RasterLayer</code> object and the you provide a cost <code>RasterLayer</code> and a <code>RasterStack</code> of feature distributions. Here we set targets for all species to protect 20% of their existing range.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">msc_model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/minsetcover_model.html">minsetcover_model</a></span>(<span class="dt">x =</span> cost, <span class="dt">features =</span> species, <span class="dt">targets =</span> <span class="fl">0.2</span>)</code></pre></div>
<p>The resulting model object is a list with class <code>minsetcover_model</code> that contains the model definition in a standard format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(msc_model)
<span class="co">#&gt; [1] "minsetcover_model" "prioritizr_model"</span>
<span class="kw">names</span>(msc_model)
<span class="co">#&gt; [1] "cost"       "rij"        "targets"    "locked_in"  "locked_out"</span>
<span class="co">#&gt; [6] "included"</span>
<span class="kw">str</span>(msc_model)
<span class="co">#&gt; List of 6</span>
<span class="co">#&gt;  $ cost      : num [1:10000] 1016 1025 1026 1023 1023 ...</span>
<span class="co">#&gt;  $ rij       :List of 6</span>
<span class="co">#&gt;   ..$ i       : int [1:12000] 4 2 3 4 2 3 4 2 4 4 ...</span>
<span class="co">#&gt;   ..$ j       : int [1:12000] 1 2 2 2 3 3 3 4 4 5 ...</span>
<span class="co">#&gt;   ..$ v       : num [1:12000] 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;   ..$ nrow    : int 4</span>
<span class="co">#&gt;   ..$ ncol    : int 10000</span>
<span class="co">#&gt;   ..$ dimnames: NULL</span>
<span class="co">#&gt;   ..- attr(*, "class")= chr "simple_triplet_matrix"</span>
<span class="co">#&gt;  $ targets   : num [1:4] 200 1000 200 1000</span>
<span class="co">#&gt;  $ locked_in : int(0) </span>
<span class="co">#&gt;  $ locked_out: int(0) </span>
<span class="co">#&gt;  $ included  : logi TRUE</span>
<span class="co">#&gt;  - attr(*, "class")= chr [1:2] "minsetcover_model" "prioritizr_model"</span></code></pre></div>
<p>Alternatively, it&rsquo;s also possible to provide the planning units and costs as polygons, for example the hexagonal planning units created above. In this case, provide a <code>SpatialPolygonsDataFrame</code> with a single <code>cost</code> attribute. Here I also use species-specific proportional targets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># summarize costs over hexagons</span>
hex_grid$cost &lt;-<span class="st"> </span><span class="kw">extract</span>(cost, hex_grid, <span class="dt">fun =</span> sum)
msc_model_hex &lt;-<span class="st"> </span><span class="kw"><a href="../reference/minsetcover_model.html">minsetcover_model</a></span>(<span class="dt">x =</span> hex_grid, <span class="dt">features =</span> species,
                                   <span class="dt">targets =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>))</code></pre></div>
<p>Finally, costs can be provided as a numeric vector and spatial information on the planning units can left out. In this case, a representation matrix must be provided explicitly and the <code>features</code> argument is ignored. In this example, I use absolute representation targets to ensure that each species occurs in at least 100 planning units.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create representation matrix</span>
rep_mat &lt;-<span class="st"> </span><span class="kw">t</span>(species[])
<span class="co"># numeric vector of costs</span>
cost_num &lt;-<span class="st"> </span>cost[][, <span class="dv">1</span>]
msc_model_num &lt;-<span class="st"> </span><span class="kw"><a href="../reference/minsetcover_model.html">minsetcover_model</a></span>(<span class="dt">x =</span> cost_num, <span class="dt">rij =</span> rep_mat,
                                   <span class="dt">targets =</span> <span class="dv">100</span>, <span class="dt">target_type =</span> <span class="st">"absolute"</span>)</code></pre></div>
<div id="locking-inout-or-excluding-planning-units" class="section level4">
<h4 class="hasAnchor"><html><body><a href="#locking-inout-or-excluding-planning-units" class="anchor"> </a></body></html>Locking in/out or excluding planning units</h4>
<p>In some situations it may be desirable to lock certain planning units in or out of the final solution. For example, planning units that are already within protected areas are often locked in and planning units in highly developed areas such as cities are often locked out. <code>prioritzr</code> can handle locked in/out planning units in one of two ways: either provide a integer vector of planning unit indices or a binary raster layer with 1s identifying planning units to lock in or out.</p>
<p>In addition, when using a raster planning units, it&rsquo;s possible to entirely exclude certain planning units from the analysis by setting those cells in the cost layer to <code>NA</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># lock in first 100 cells using integer vector</span>
lock_in &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">100</span>
<span class="co"># lock out last 100 cells using raster</span>
lock_out &lt;-<span class="st"> </span><span class="kw">raster</span>(cost)
lock_out[] &lt;-<span class="st"> </span><span class="dv">0</span>
lock_out[<span class="dv">9901</span>:<span class="dv">10000</span>] &lt;-<span class="st"> </span><span class="dv">1</span>
<span class="co"># exclude some planning units from analysis</span>
cost_na &lt;-<span class="st"> </span>cost
cost_na[<span class="dv">5001</span>:<span class="dv">5100</span>] &lt;-<span class="st"> </span><span class="ot">NA</span>
msc_model_na &lt;-<span class="st"> </span><span class="kw"><a href="../reference/minsetcover_model.html">minsetcover_model</a></span>(<span class="dt">x =</span> cost_na, <span class="dt">features =</span> species, <span class="dt">targets =</span> <span class="fl">0.2</span>,
                               <span class="dt">locked_in =</span> lock_in, <span class="dt">locked_out =</span> lock_out)</code></pre></div>
</div>
</div>
<div id="maximum-coverage-problem" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#maximum-coverage-problem" class="anchor"> </a></body></html>Maximum coverage problem</h3>
<p>The maximum coverage problem seeks to find the set of planning units that maximizes the overall level of representation across a suite of conservation features, while keeping cost within a fixed budget. This problem is roughly the opposite of what the conservation planning software Marxan does. The maximum coverage problem can be stated mathematically, for <span class="math inline">\(n\)</span> planning units and <span class="math inline">\(m\)</span> conservation features, as:</p>
<p><span class="math display">\[
\text{Maximize} \sum_{i=1}^{m} \sum_{j=1}^{n} x_j r_{ij} + 
\text{ subject to } \sum_{i=1}^{n}x_i c_i
\leq B
\]</span></p>
<p>where <span class="math inline">\(x_i\)</span> is a binary decision variable specifying whether planning unit <span class="math inline">\(i\)</span> has been selected (1) or not (0), <span class="math inline">\(c_i\)</span> is the cost of planning unit <span class="math inline">\(i\)</span>, <span class="math inline">\(r_{ij}\)</span> is the representation level of feature <span class="math inline">\(i\)</span> in planning unit <span class="math inline">\(j\)</span>, and <span class="math inline">\(B\)</span> is the budget.</p>
<p>To specify a prioritization model of this type we use the <code><a href="../reference/maxcover_model.html">maxcover_model()</a></code> function to create a <code>maxcover_model</code> S3 object. Here we set the budget to 25% of the total cost of the study area.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_25 &lt;-<span class="st"> </span><span class="fl">0.25</span> *<span class="st"> </span>raster::<span class="kw">cellStats</span>(cost, <span class="st">"sum"</span>)
mc_model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/maxcover_model.html">maxcover_model</a></span>(<span class="dt">x =</span> cost, <span class="dt">features =</span> species, <span class="dt">budget =</span> b_25)
<span class="kw">class</span>(mc_model)
<span class="co">#&gt; [1] "maxcover_model"   "prioritizr_model"</span></code></pre></div>
<p>As with <code><a href="../reference/minsetcover_model.html">minsetcover_model()</a></code>, different input data types are permitted and planning units can be locked in or out.</p>
</div>
<div id="maximum-target-coverage-problem" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#maximum-target-coverage-problem" class="anchor"> </a></body></html>Maximum target coverage problem</h3>
<p>The maximum target coverage problem is a hybrid between the prior two problem types in that it allows for both a budget and targets to be set. This problem finds the set of planning units that meets representation targets for the most species while staying within a fixed budget. If multiple solutions can meet all targets while staying within budget, the cheapest solution is chosen. The maximum target coverage problem can be stated mathematically, for <span class="math inline">\(n\)</span> planning units and <span class="math inline">\(m\)</span> conservation features, as:</p>
<p><span class="math display">\[
\text{Maximize} \space -a\sum_{i=1}^{n} x_i c_i + \sum_{j=1}^{m}y_j
\]</span></p>
<p>Subject to:</p>
<p><span class="math display">\[
\sum_{i=1}^{n}x_i c_i \leq B \space \text{and} \space 
\sum_{j=1}^{n} x_j r_{ij}
\geq y_iT_i \space \forall \space i 
\]</span></p>
<p>where <span class="math inline">\(x_i\)</span> is a binary decision variable specifying whether planning unit <span class="math inline">\(i\)</span> has been selected (1) or not (0), <span class="math inline">\(y_i\)</span> is a binary decision variable specifying whether the target for species <span class="math inline">\(i\)</span> should be met, <span class="math inline">\(c_i\)</span> is the cost of planning unit <span class="math inline">\(i\)</span>, <span class="math inline">\(r_{ij}\)</span> is the representation level of feature <span class="math inline">\(i\)</span> in planning unit <span class="math inline">\(j\)</span>, <span class="math inline">\(B\)</span> is the budget, and <span class="math inline">\(T_i\)</span> is the target for feature <span class="math inline">\(i\)</span>. Finally, the factor <span class="math inline">\(a\)</span> is chosen so that the first term of the objective function is much smaller than the second. This ensures that the reserve cost only plays a role in distinguishing between solutions that meet the same number of targets.</p>
<p>To specify a prioritization model of this type use the <code><a href="../reference/maxtargets_model.html">maxtargets_model()</a></code> function to create a <code>maxtargets_model</code> S3 object. Here we set the budget to 5% of the total cost of the study area and choose targets such that 50% of each species&rsquo; existing range will be protected.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_5 &lt;-<span class="st"> </span><span class="fl">0.05</span> *<span class="st"> </span>raster::<span class="kw">cellStats</span>(cost, <span class="st">"sum"</span>)
mtc_model &lt;-<span class="st"> </span><span class="kw"><a href="../reference/maxtargets_model.html">maxtargets_model</a></span>(<span class="dt">x =</span> cost, <span class="dt">features =</span> species, <span class="dt">targets =</span> <span class="fl">0.5</span>, 
                              <span class="dt">budget =</span> b_5)
<span class="kw">class</span>(mtc_model)
<span class="co">#&gt; [1] "maxtargets_model" "prioritizr_model"</span></code></pre></div>
</div>
</div>
<div id="solving-prioritization-problems" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#solving-prioritization-problems" class="anchor"> </a></body></html>Solving prioritization problems</h2>
<p>The function <code><a href="../reference/prioritize.html">prioritize()</a></code> offers a unified interface to solving either type of prioritization problem using any of the available solvers. For example, to solve the minimum set cover problem from above use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">msc_results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(msc_model)</code></pre></div>
<p>The resulting <code>prioritizr_results</code> S3 object contains the following elements:</p>
<ul><li><code>x</code>: a vector of decision variables for the best solution. 1 indicates that a planning unit is selected, 0 that it isn&rsquo;t.</li>
<li><code>objval</code>: the objective function value for the optimal solution.</li>
<li><code>objbound</code>: a lower bound on the objective function. This is useful only if the solver was stopped before finding the optimum. If the solver was run to completion, <code>objbound</code> and <code>objval</code> will be equal. Only Gurobi returns a bound, therefore this component will be <code>NA</code> if another solver is used.</li>
<li><code>gap</code>: the relative gap to optimality: <code>objval / objbound - 1</code>. gap will be zero if the solver was run to completion and the true optimum was found.</li>
<li><code>time</code>: the execution time in seconds.</li>
</ul><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(msc_results)
<span class="co">#&gt; [1] "prioritizr_results"</span>
<span class="kw">str</span>(msc_results)
<span class="co">#&gt; List of 5</span>
<span class="co">#&gt;  $ x       : int [1:10000] 0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;  $ objval  : num 985394</span>
<span class="co">#&gt;  $ objbound: num 985394</span>
<span class="co">#&gt;  $ gap     : num 0</span>
<span class="co">#&gt;  $ time    : num 0.075</span>
<span class="co">#&gt;  - attr(*, "class")= chr "prioritizr_results"</span></code></pre></div>
<div id="alternative-solvers" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#alternative-solvers" class="anchor"> </a></body></html>Alternative solvers</h3>
<p>By default, this function uses the best available solver, which is Gurobi if it is installed. Alternatively, the solver can be specified explicitly. For example, to solve the maximum coverage problem with SYMPHONY use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mc_results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(mc_model, <span class="dt">solver =</span> <span class="st">"symphony"</span>)</code></pre></div>
<p>Alternatively, you can call one of the solver-specific functions. For example, to solve the maximum target coverage problem with GLPK use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtc_results &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize_glpk</a></span>(mtc_model)</code></pre></div>
</div>
<div id="multi-threading" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#multi-threading" class="anchor"> </a></body></html>Multi-threading</h3>
<p>If your machine has multiple cores, Gurobi will generally use all the available cores. If you want to control this behaviour and, for example, only run Gurobi on a single core, set the <code>threads</code> argument to <code><a href="../reference/prioritize.html">prioritize()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">msc_results_threads &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(msc_model, <span class="dt">gap =</span> <span class="fl">0.01</span>, <span class="dt">threads =</span> <span class="dv">1</span>)</code></pre></div>
<p>The number of threads can&rsquo;t be set for GLPK and SYMPHONY.</p>
</div>
<div id="stopping-conditions" class="section level3">
<h3 class="hasAnchor"><html><body><a href="#stopping-conditions" class="anchor"> </a></body></html>Stopping conditions</h3>
<p>Although the ILP solvers can find the exact optimal solution to a prioritization problem, doing so is often time consuming and unnecessary. Instead <code><a href="../reference/prioritize.html">prioritize()</a></code> can direct the solvers to stop early by using one of three <strong>stopping condition</strong> parameters: <code>gap</code>, <code>time_limit</code>, and <code>first_feasible</code>.</p>
<p>To direct the solvers to stop once a solution is found within a given relative gap to optimality use the <code>gap</code> parameter. For example, to ensure that the solution is at worst 1% of optimality use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">msc_results_gap &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(msc_model, <span class="dt">gap =</span> <span class="fl">0.01</span>)</code></pre></div>
<p>To direct the solver to stop after a given time limit use the <code>time_limit</code> parameter. For example, to return the best solution after 1 second use:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">msc_results_time &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(msc_model, <span class="dt">time_limit =</span> <span class="dv">1</span>)</code></pre></div>
<p>Finally, to return the first solution found that meets all the constraints regardless of the objective function value use <code>first_feasible = TRUE</code>. <strong>Note that GLPK doesn&rsquo;t accept this argument.</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">msc_results_ff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(msc_model, <span class="dt">first_feasible =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>Note that to ensure <code><a href="../reference/prioritize.html">prioritize()</a></code> returns in a reasonable amount of time, the default stopping condition is <code>gap = 0.0001</code>. To override this and return the exact optimal solution, use the following, however, note that this may take significantly longer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">msc_results_exact &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(msc_model, <span class="dt">gap =</span> <span class="dv">0</span>)</code></pre></div>
</div>
</div>
<div id="inspecting-the-results" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#inspecting-the-results" class="anchor"> </a></body></html>Inspecting the results</h2>
<p>The resulting solutions can be displayed by passing the planning units and solution vector to <code><a href="../reference/plot_selection.html">plot_selection()</a></code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_selection.html">plot_selection</a></span>(cost, msc_results$x, <span class="dt">title =</span> <span class="st">"Minimum Set Cover"</span>)</code></pre></div>
<p><img src="figures/full_solutions-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The cost of a given solution can easily be calculated with:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(mc_results$x[mc_model$included] *<span class="st"> </span>mc_model$cost)
<span class="co">#&gt; [1] 2458660</span></code></pre></div>
<p>To calculate the representation level for each feature, and check if the targets were met, use matrix multiplication:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rep_lev &lt;-<span class="st">  </span>(<span class="kw">as.matrix</span>(mtc_model$rij) %*%<span class="st"> </span>mtc_results$x[mtc_model$included])[, <span class="dv">1</span>]
rep_lev
<span class="co">#&gt; [1] 500 268  24 136</span>
<span class="co"># targets met?</span>
rep_lev &gt;=<span class="st"> </span>mtc_model$targets
<span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE</span></code></pre></div>
<p>Alternatively, these values can be calculated using the <code><a href="../reference/solution_summary.html">solution_summary()</a></code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/solution_summary.html">solution_summary</a></span>(mtc_model, mtc_results)
<span class="co">#&gt; $n_pu</span>
<span class="co">#&gt; [1] 500</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $cost</span>
<span class="co">#&gt; [1] 481435.8</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $amount_held</span>
<span class="co">#&gt; [1] 500 268  24 136</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $targets_met</span>
<span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE</span></code></pre></div>
<p>Looks like only a single target was met. Obviously, the budget was set too low or the targets too high. Let&rsquo;s explore this relationship between the budget and the number of targets achieved by varying the budget from 1% to 10% of the total cost of the study area.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># budgets from 1-10% of total cost</span>
budgets &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.01</span>) *<span class="st"> </span>raster::<span class="kw">cellStats</span>(cost, <span class="st">"sum"</span>)
costs &lt;-<span class="st"> </span><span class="kw">numeric</span>()
targets_met &lt;-<span class="st"> </span><span class="kw">numeric</span>()
for (b in budgets) {
  m &lt;-<span class="st"> </span><span class="kw"><a href="../reference/maxtargets_model.html">maxtargets_model</a></span>(<span class="dt">x =</span> cost, <span class="dt">features =</span> species, <span class="dt">targets =</span> <span class="fl">0.2</span>, <span class="dt">budget =</span> b)
  r &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prioritize.html">prioritize</a></span>(m)
  s &lt;-<span class="st"> </span><span class="kw"><a href="../reference/solution_summary.html">solution_summary</a></span>(m, r)
  costs &lt;-<span class="st"> </span><span class="kw">c</span>(costs, s$cost)
  targets_met &lt;-<span class="st"> </span><span class="kw">c</span>(targets_met, <span class="kw">sum</span>(s$targets_met))
}
cost_target &lt;-<span class="st"> </span><span class="kw">data.frame</span>(costs, targets_met)
<span class="kw">ggplot</span>(cost_target, <span class="kw">aes</span>(costs /<span class="st"> </span><span class="fl">1e6</span>, targets_met)) +
<span class="st">  </span><span class="kw">geom_line</span>() +
<span class="st">  </span><span class="kw">geom_point</span>() +
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Cost (millions)"</span>, <span class="dt">y =</span> <span class="st">"# Targets Met"</span>,
       <span class="dt">title =</span> <span class="st">"More targets met as budget increases"</span>)</code></pre></div>
<p><img src="figures/full_budget-targets-1.png" width="672" style="display: block; margin: auto;"></p>
<p>So, in a maximum target coverage model, as the budget increases the number of targets met will increase accordingly. Remember that if there are multiple solutions that meet all the targets the chosen solution will be the one that also has the lowest cost.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#background">Background</a><ul class="nav nav-pills nav-stacked"><li><a href="#reserve-design">Reserve design</a></li>
      <li><a href="#mathematical-formulation">Mathematical formulation</a></li>
      <li><a href="#integer-linear-programming-ilp">Integer linear programming (ILP)</a></li>
      </ul></li>
      <li><a href="#using-prioritizr">Using <code>prioritizr</code></a><ul class="nav nav-pills nav-stacked"><li><a href="#data-generation">Data generation</a></li>
      <li><a href="#problem-specification">Problem specification</a></li>
      <li><a href="#solving-prioritization-problems">Solving prioritization problems</a></li>
      <li><a href="#inspecting-the-results">Inspecting the results</a></li>
      </ul></li>
      </ul></div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matthew Strimas-Mackey.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer></div>

  </body></html>
